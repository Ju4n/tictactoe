<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<style>
  body {
    background-color: #6c757d;
    max-width: fit-content;
    margin-left: auto;
    margin-right: auto;
    margin-top: 20%;
  }
  canvas {
    border: none;
    background-color: #FFFFFF;
    border-left: 2px solid #6c757d;
  }
  .container {
    display: flex;
    flex-direction: column;
  }
  .resetb {
    margin-bottom: 30px;
  }
  .score {
    margin-left: 15px;
  }
  .hide {
    display: none;
  }
  .center {
    margin-left: 27%;
  }
</style>
  </head>
  <body>
    <div class="score">
      <h1 id="scorex" class="center hide">❌ HAS WON</h1>
      <h1 id="scoreo" class="center hide">⭕ HAS WON</h1>
      <button id="reset" class="btn btn-warning resetb">Reset</button>
    </div>
    <div class="container">
      <div>
        <canvas class="square" id="0_0" width="200" height="200"></canvas>
        <canvas class="square" id="0_1" width="200" height="200"></canvas>
        <canvas class="square" id="0_2" width="200" height="200"></canvas>
      </div>
      <div>
        <canvas class="square" id="1_0" width="200" height="200"></canvas>
        <canvas class="square" id="1_1" width="200" height="200"></canvas>
        <canvas class="square" id="1_2" width="200" height="200"></canvas>
      </div>
      <div>
        <canvas class="square" id="2_0" width="200" height="200"></canvas>
        <canvas class="square" id="2_1" width="200" height="200"></canvas>
        <canvas class="square" id="2_2" width="200" height="200"></canvas>
      </div>
    </div>
  </body>
</html>
<script type="text/javascript">
  //get the board state
  $(document).ready(async function () {
    const result = await fetch('http://localhost:8080/api/state');
    const board = result.ok ? await result.json() : alert('error');
    for (data of board.positions) {
      const [id, token] = data.split('-');
      console.log(id, token);
      if (token == 'X') {
        drawCross(id);
      }

      if (token == 'O') {
        drawCircle(id)
      }
    }
  });

  $('#reset').click(async function () {
    const result = await fetch('http://localhost:8080/api/restart');
    if (result.ok) {
      location.reload();
    }
  })

  $('.square').click(async (link) => {
    if (!$(link.target).hasClass('used')) {
      const id = $(link.target).attr('id');
      let turn = localStorage.getItem("turn");
      if (turn === 'circle') {
        drawCircle(id);
        turn = 'cross';
      } else if (turn === 'cross') {
        drawCross(id);
        turn = 'circle';
      } else {
        drawCross(id);
        turn = 'cross';
      }
      const cord = id.split('_');
      const token = turn === 'circle' ? 'X' : 'O';
      const data = await verify(+cord[0], +cord[1], token);
      const result = data.ok ? await data.json() : alert('ERROR!');
      if (result.finished) {
        if (result.winner == 'X') {
          $('#scorex').show();
        }
        if (result.winner == 'O') {
          $('#scoreo').show();
        }

        $('.square').unbind('click');
      }

      $(link.target).addClass('used');
      localStorage.setItem('turn', turn);
    }
  });

                                                  async function verify(x, y, token) {
  const result = await fetch('http://localhost:8080/api/verify', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      x,
      y,
      token
    })
  })

                                                  return result;
}

function drawCircle(id) {
  const text = "⭕";
  const c = document.getElementById(id);
  const ctx = c.getContext("2d");
  ctx.font = "100px sans-serif";
  ctx.textBaseline = 'middle';
  ctx.textAlign = 'center';
  ctx.fillText(text, 100, 100);
}

function drawCross(id) {
  const text = "❌";
  const c = document.getElementById(id);
  const ctx = c.getContext("2d");
  ctx.font = "100px sans-serif";
  ctx.textBaseline = 'middle';
  ctx.textAlign = 'center';
  ctx.fillText(text, 100, 100);
}
</script>
